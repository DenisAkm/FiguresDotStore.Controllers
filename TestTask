using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace FiguresDotStore.Controllers
{
	internal interface IRedisClient
	{
		int Get(string type);
		void Set(string type, int current);
	}
	
	public static class FiguresStorage
	{
		private static IRedisClient RedisClient { get; }
	
		public static bool CheckIfAvailable(string type, int count)
		{
			return RedisClient.Get(type) >= count;
		}

		public static void Reserve(string type, int count)
		{
			var current = RedisClient.Get(type);

			RedisClient.Set(type, current - count);
		}
	}

	public class Position
	{
		public string Type { get; set; }

		public float SideA { get; set; }
		public float SideB { get; set; }
		public float SideC { get; set; }

		public int Count { get; set; }
	}

	public class Cart
	{
		public List<Position> Positions { get; set; }
	}

    public class Order
    {
        public List<IFigure> Positions { get; set; }

        public decimal GetTotal() => Positions.Select(p => p switch
            {
                Triangle _ => (decimal) p.GetArea() * 1.2m,
                Circle _ => (decimal) p.GetArea() * 0.9m,
                //Square _ => (decimal)p.GetArea() ?
            })
            .Sum();
    }

    public interface IFigure
	{
        void Validate();
		double GetArea();
	}

	public class Triangle : IFigure
	{
		public float[] Dimentions { get; set; }
		private float? _perimeter;

        public Triangle(float sideA, float sideB, float sideC)
        {
            Dimentions = new[] {sideA, sideB, sideC};
        }
		private float Perimeter
		{
			get => _perimeter ?? Dimentions.Sum();
			set => _perimeter = value;
		}

        public void Validate()
		{
			if (Dimentions.Length != 3 ||
				Dimentions.Any(x => x < 0) ||
				Dimentions.Any(x => x >= Perimeter - x))
			{
				throw new InvalidOperationException("Triangle restrictions not met");
			}
        }

		public double GetArea()
		{
			var p = Perimeter / 2;
			return Math.Sqrt(p * (p - Dimentions[0]) * (p - Dimentions[1]) * (p - Dimentions[2]));
		}
	}
	
	public class Square : IFigure
	{
		public float[] Dimentions { get; set; }

        public Square(float sideA, float sideB)
        {
            Dimentions = new[] {sideA, sideB};
        }

		public void Validate()
		{
			if (Dimentions.Any(x => x < 0) ||
				Dimentions.Any(x => x != Dimentions.First()))
				throw new InvalidOperationException("Square restrictions not met");
		}

		public double GetArea() => Dimentions.First() * Dimentions.First();
	}
	
	public class Circle : IFigure
	{
		public float[] Dimentions { get; set; }

        public Circle(float radius)
        {
            Dimentions = new[] { radius };
        }

		public void Validate()
		{
			if (Dimentions.First() < 0)
				throw new InvalidOperationException("Circle restrictions not met");
		}

		public double GetArea() => Math.PI * Dimentions.First() * Dimentions.First();
	}

	public interface IOrderStorage
	{
		Task<decimal> Save(Order order);
	}
	
	[ApiController]
	[Route("[controller]")]
	public class FiguresController : ControllerBase
	{
		private readonly ILogger<FiguresController> _logger;
		private readonly IOrderStorage _orderStorage;

		public FiguresController(ILogger<FiguresController> logger, IOrderStorage orderStorage)
		{
			_logger = logger;
			_orderStorage = orderStorage;
		}

		[HttpPost]
		public async Task<ActionResult> Order(Cart cart)
		{
			if (cart == null) return new BadRequestResult();
			if (cart.Positions.Any(p => !FiguresStorage.CheckIfAvailable(p.Type, p.Count)))
				return new BadRequestResult();

			var order = BuildOrderFromCart(cart);
			cart.Positions.ForEach(p => FiguresStorage.Reserve(p.Type, p.Count));
			var result = _orderStorage.Save(order);

			return new OkObjectResult(result.Result);
		}

		private Order BuildOrderFromCart(Cart cart)
		{
			var positions = cart.Positions.Select(p =>
			{
				IFigure figure = p.Type
                switch
                {
                    "Circle" => new Circle(p.SideA),
                    "Triangle" => new Triangle(p.SideA, p.SideB, p.SideC),
                    "Square" => new Square(p.SideA, p.SideB),
                    _ => throw new NotImplementedException()
                };

				figure.Validate();
				return figure;
			}).ToList();

			return new Order { Positions = positions };
		}
	}
}
